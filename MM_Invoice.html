<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Quotation & Invoice - Meramu Design</title>
    
    <!-- Load React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Load Babel untuk compile kode React di browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Load html2canvas untuk fitur Save JPEG -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <!-- Load Markdown Parser untuk respon AI yang rapi -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Konfigurasi Tailwind untuk Font & Warna -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        meramu: {
                            green: '#569674',
                            cream: '#fef5da',
                            dark: '#2A4036'
                        }
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        @media print {
            @page { margin: 0; size: auto; }
            body { -webkit-print-color-adjust: exact; }
            .no-print { display: none !important; }
        }
        /* Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #569674;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #407558;
        }
        /* Markdown Styles for AI Response */
        .prose h1, .prose h2, .prose h3 { font-weight: bold; margin-top: 0.5em; margin-bottom: 0.25em; color: #2A4036; }
        .prose p { margin-bottom: 0.5em; }
        .prose ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 0.5em; }
        .prose strong { color: #569674; }
    </style>
</head>
<body class="bg-meramu-cream">
    <div id="root"></div>

    <script type="text/babel">
        // Definisi Ikon
        const Plus = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
        );
        const Trash2 = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
        );
        const Printer = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
        );
        const FileText = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
        );
        const Save = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
        );
        const History = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 3v5h5"></path><path d="M3.05 13A9 9 0 1 0 6 5.3L3 8"></path><path d="M12 7v5l4 2"></path></svg>
        );
        const X = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        );
        const Check = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="20 6 9 17 4 12"></polyline></svg>
        );
        const Sparkles = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/>
            </svg>
        );
        const Copy = ({ size = 16, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/>
            </svg>
        );
        const ImageIcon = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/>
            </svg>
        );
        const Send = ({ size = 16, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
        );
        const MessageSquare = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
        );

        const QuotationApp = () => {
            const [docType, setDocType] = React.useState('quotation');
            const [showHistory, setShowHistory] = React.useState(false);
            const [showAI, setShowAI] = React.useState(false); 
            const [savedHistory, setSavedHistory] = React.useState([]);
            const [saveStatus, setSaveStatus] = React.useState(null);
            
            // State Counter Nomor Dokumen
            const [monthlyCounters, setMonthlyCounters] = React.useState({});

            // State untuk AI Modal & API Key
            const [aiTab, setAiTab] = React.useState('reply'); // 'reply' (Template) or 'consult' (Real Chat)
            const [userApiKey, setUserApiKey] = React.useState('');
            const [chatInput, setChatInput] = React.useState('');
            const [isAiLoading, setIsAiLoading] = React.useState(false);
            const [aiChatResponse, setAiChatResponse] = React.useState('');
            const [aiResult, setAiResult] = React.useState(null); // Untuk template

            const [quotationData, setQuotationData] = React.useState({
                number: '', 
                date: new Date().toISOString().slice(0, 10),
                dueDate: new Date(Date.now() + 14 * 24 * 60 * 60 * 1000).toISOString().slice(0, 10),
                senderName: 'Meramu Design',
                senderAddress: 'PTB Duren Sawit, JL Bima B3 no 11,\nKlender, Jakarta Timur',
                senderPhone: '+62 812-9988-7766',
                clientName: 'Klien Project Mesin Otomatis',
                clientAddress: 'Via Threads Inquiry',
                notes: 'Estimasi Timeline Pengerjaan: 4-6 Minggu.\nHarga di atas adalah biaya desain (Design Fee), tidak termasuk biaya produksi fisik/cetak stiker mesin.',
            });

            const [items, setItems] = React.useState([
                { id: 1, description: 'Brand Identity (Logo, Usage, Color Palette, Typography, Visual System)', qty: 1, price: 6500000 },
                { id: 2, description: 'Machine Surface Branding (Wrap Design & Physical Mockup)', qty: 1, price: 3500000 },
                { id: 3, description: 'UI/UX Design for Machine Interface (Kiosk Mode/Touch Screen)', qty: 1, price: 7000000 },
                { id: 4, description: 'Supporting Visual Components (Icons, Instructional Graphics)', qty: 1, price: 1500000 },
            ]);

            const [discountPercent, setDiscountPercent] = React.useState(5);
            const [taxPercent, setTaxPercent] = React.useState(0);

            // Load data dari LocalStorage
            React.useEffect(() => {
                const loadedHistory = localStorage.getItem('invoiceHistory');
                if (loadedHistory) {
                    setSavedHistory(JSON.parse(loadedHistory));
                }
                const savedCounters = localStorage.getItem('monthlyCounters');
                if (savedCounters) {
                    setMonthlyCounters(JSON.parse(savedCounters));
                }
                const savedKey = localStorage.getItem('geminiApiKey');
                if (savedKey) {
                    setUserApiKey(savedKey);
                }
            }, []);

            // --- FUNGSI AI CHAT (Direct Gemini) ---
            const handleSaveApiKey = (e) => {
                const key = e.target.value;
                setUserApiKey(key);
                localStorage.setItem('geminiApiKey', key);
            };

            const callGeminiChat = async () => {
                if (!chatInput.trim()) return;
                if (!userApiKey) {
                    alert("Masukkan API Key Gemini dulu ya! (Gratis di aistudio.google.com)");
                    return;
                }

                setIsAiLoading(true);
                const prompt = chatInput;
                setChatInput(''); // Clear input

                try {
                    // Endpoint Gemini Flash
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${userApiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: `Kamu adalah asisten bisnis untuk desainer freelance profesional bernama Meramu Design. Jawablah dengan bahasa Indonesia yang santai tapi profesional. Pertanyaan: ${prompt}` }] }]
                        })
                    });

                    if (!response.ok) {
                        throw new Error('Gagal menghubungi Gemini. Cek API Key Anda.');
                    }

                    const data = await response.json();
                    const textResponse = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    setAiChatResponse(textResponse || "Maaf, saya tidak mengerti.");
                } catch (error) {
                    setAiChatResponse("Error: " + error.message);
                } finally {
                    setIsAiLoading(false);
                }
            };

            // --- FUNGSI AUTO NUMBER ---
            const getInitials = (name) => {
                if (!name) return 'CLI';
                const words = name.trim().split(/\s+/);
                if (words.length === 0) return 'CLI';
                let initials = words.map(word => word[0].toUpperCase()).join('').slice(0, 3);
                return initials;
            };

            const getDateFormat = (dateString) => {
                if (!dateString) return '';
                return dateString.replaceAll('-', '');
            };

            const getMonthKey = (dateString) => {
                if (!dateString) return new Date().toISOString().slice(0, 7);
                return dateString.slice(0, 7);
            };

            const generateDocNumber = (currentType, currentName, currentDate, counters) => {
                const prefix = currentType === 'quotation' ? 'QT' : 'INV';
                const initials = getInitials(currentName);
                const dateStr = getDateFormat(currentDate);
                
                const monthKey = getMonthKey(currentDate);
                const currentCounter = counters[monthKey] || 1;
                const counterStr = String(currentCounter).padStart(3, '0');
                
                return `${prefix}-MM-${initials}${dateStr}-${counterStr}`;
            };

            React.useEffect(() => {
                const newNumber = generateDocNumber(docType, quotationData.clientName, quotationData.date, monthlyCounters);
                setQuotationData(prev => ({ ...prev, number: newNumber }));
            }, [docType, quotationData.clientName, quotationData.date, monthlyCounters]);


            // Kalkulasi
            const subtotal = items.reduce((acc, item) => acc + (item.qty * item.price), 0);
            const discountAmount = (subtotal * discountPercent) / 100;
            const taxableAmount = subtotal - discountAmount;
            const taxAmount = (taxableAmount * taxPercent) / 100;
            const grandTotal = taxableAmount + taxAmount;
            const dpAmount = grandTotal * 0.5;
            const remainingAmount = grandTotal - dpAmount;

            const getDocTitle = (type) => {
                switch(type) {
                    case 'invoice_dp': return { main: 'INVOICE (DP)', sub: 'Tagihan Uang Muka' };
                    case 'invoice_final': return { main: 'INVOICE', sub: 'Tagihan Pelunasan' };
                    default: return { main: 'QUOTATION', sub: 'Proposal Penawaran' };
                }
            }

            const formatIDR = (amount) => {
                return new Intl.NumberFormat('id-ID', {
                    style: 'currency',
                    currency: 'IDR',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0,
                }).format(amount);
            };

            const handleItemChange = (id, field, value) => {
                setItems(items.map(item => 
                    item.id === id ? { ...item, [field]: value } : item
                ));
            };

            const addItem = () => {
                const newId = items.length > 0 ? Math.max(...items.map(i => i.id)) + 1 : 1;
                setItems([...items, { id: newId, description: 'Additional Scope', qty: 1, price: 0 }]);
            };

            const removeItem = (id) => {
                setItems(items.filter(item => item.id !== id));
            };

            const handlePrint = () => {
                window.print();
            };

            const handleSaveJpeg = async () => {
                const element = document.getElementById('quotation-paper');
                if (!element) return;
                try {
                    const canvas = await html2canvas(element, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
                    const link = document.createElement('a');
                    link.download = `${quotationData.number || 'Dokumen'}.jpg`;
                    link.href = canvas.toDataURL('image/jpeg', 0.9);
                    link.click();
                } catch (err) {
                    alert("Maaf, terjadi kesalahan saat menyimpan gambar.");
                }
            };

            const handleSaveToHistory = () => {
                const newEntry = {
                    id: Date.now(),
                    saveDate: new Date().toLocaleString('id-ID'),
                    docType,
                    quotationData,
                    items,
                    discountPercent,
                    taxPercent,
                    grandTotal
                };
                
                const updatedHistory = [newEntry, ...savedHistory];
                setSavedHistory(updatedHistory);
                localStorage.setItem('invoiceHistory', JSON.stringify(updatedHistory));
                
                const monthKey = getMonthKey(quotationData.date);
                const currentMonthCounter = monthlyCounters[monthKey] || 1;
                const nextCounter = currentMonthCounter + 1;
                
                const updatedCounters = {
                    ...monthlyCounters,
                    [monthKey]: nextCounter
                };
                
                setMonthlyCounters(updatedCounters);
                localStorage.setItem('monthlyCounters', JSON.stringify(updatedCounters));

                setSaveStatus('saved');
                setTimeout(() => setSaveStatus(null), 2000);
            };

            const handleLoadFromHistory = (entry) => {
                if (window.confirm('Dokumen saat ini akan tertimpa dengan data yang dipilih. Lanjutkan?')) {
                    setDocType(entry.docType);
                    setQuotationData(entry.quotationData);
                    setItems(entry.items);
                    setDiscountPercent(entry.discountPercent);
                    setTaxPercent(entry.taxPercent);
                    setShowHistory(false);
                }
            };

            const handleDeleteHistory = (id, e) => {
                e.stopPropagation();
                if (window.confirm('Hapus item riwayat ini?')) {
                    const updatedHistory = savedHistory.filter(item => item.id !== id);
                    setSavedHistory(updatedHistory);
                    localStorage.setItem('invoiceHistory', JSON.stringify(updatedHistory));
                }
            };

            const handleCopyText = (text) => {
                navigator.clipboard.writeText(text);
                alert("Teks berhasil disalin!");
            };

            const generateReplyTemplate = (type) => {
                let template = "";
                if (type === 'nego') {
                    template = `Halo [Nama Klien],\n\nTerima kasih atas penawarannya. Saya sangat tertarik untuk membantu project ini.\n\nMengenai budget, untuk scope pekerjaan yang diminta (termasuk A, B, C), harga yang saya ajukan di angka Rp [Harga Awal] sudah merupakan estimasi terbaik saya untuk memastikan kualitas hasil maksimal.\n\nNamun, jika budget memang terbatas di angka Rp [Harga Nego], mungkin kita bisa sesuaikan scope-nya, misalnya dengan mengurangi [Scope X] atau [Scope Y].\n\nBagaimana menurut Anda? Mari kita diskusikan solusinya.\n\nSalam,\n${quotationData.senderName}`;
                } else if (type === 'invoice') {
                    template = `Halo [Nama Klien],\n\nSemoga hari Anda menyenangkan.\n\nBerikut saya lampirkan Invoice untuk termin [DP/Pelunasan] project [Nama Project].\n\nMohon dapat diproses pembayarannya ke rekening yang tertera di invoice agar pengerjaan/pengiriman file final dapat segera dilakukan.\n\nTerima kasih banyak atas kerjasamanya.\n\nSalam,\n${quotationData.senderName}`;
                } else if (type === 'dp') {
                    template = `Halo [Nama Klien],\n\nTerima kasih sudah mempercayakan project ini kepada saya.\n\nSesuai kesepakatan, saya akan mulai mengerjakan tahap awal setelah Down Payment (DP) sebesar 50% diterima. Berikut saya lampirkan Invoice DP-nya.\n\nSegera kabari jika transfer sudah dilakukan ya, supaya bisa langsung saya jadwalkan pengerjaannya.\n\nTerima kasih!\n\nSalam,\n${quotationData.senderName}`;
                } else if (type === 'pricelist') {
                    template = `Halo [Nama Klien],\n\nThanks for reaching out! Senang sekali bisa terhubung dengan Anda.\n\nMenjawab inquiry Anda, berikut saya lampirkan Quotation/Pricelist untuk kebutuhan project tersebut. Silakan dipelajari terlebih dahulu detail scope dan harganya.\n\nJangan ragu untuk diskusi ya, karena harga yang tertera masih bisa kita sesuaikan (negotiable) bergantung pada kebutuhan spesifik atau budget yang Anda miliki.\n\nDitunggu kabar baiknya!\n\nSalam,\n${quotationData.senderName}`;
                }
                setAiResult({ type: 'text', content: template });
            };

            return (
                <div className="min-h-screen bg-meramu-cream p-4 md:p-8 font-sans print:bg-white print:p-0">
                
                {/* Control Panel */}
                <div className="max-w-4xl mx-auto mb-6 bg-[#FAF9F6] p-4 rounded-lg shadow-sm flex flex-col md:flex-row gap-4 items-center justify-between no-print border border-[#D8D4C9]">
                    <div className="flex flex-col gap-2 w-full md:w-auto">
                        <div className="flex items-center gap-2 text-meramu-dark">
                            <FileText size={20} />
                            <span className="font-semibold">Jenis Dokumen:</span>
                        </div>
                        <div className="flex bg-meramu-cream rounded-lg p-1 gap-1 w-full md:w-auto">
                            {['quotation', 'invoice_dp', 'invoice_final'].map(type => (
                                <button 
                                    key={type}
                                    onClick={() => setDocType(type)}
                                    className={`flex-1 md:flex-none px-3 py-1 text-xs font-medium rounded-md transition-all ${docType === type ? 'bg-meramu-green text-white shadow' : 'text-meramu-dark hover:bg-white'}`}
                                >
                                    {type === 'quotation' ? 'Quotation' : type === 'invoice_dp' ? 'Invoice DP' : 'Pelunasan'}
                                </button>
                            ))}
                        </div>
                    </div>
                    
                    <div className="flex flex-wrap gap-2 w-full md:w-auto justify-end">
                        <button 
                            onClick={() => setShowAI(true)}
                            className="flex items-center gap-2 bg-white border border-meramu-green text-meramu-green px-3 py-2 rounded-lg hover:bg-green-50 transition-colors text-sm font-bold cursor-pointer shadow-sm"
                        >
                            <MessageSquare size={16} />
                            <span className="hidden sm:inline">Template Balasan</span>
                        </button>

                        <button 
                            onClick={() => setShowHistory(true)}
                            className="flex items-center gap-2 bg-white border border-[#D1D8C6] text-meramu-dark px-3 py-2 rounded-lg hover:bg-gray-50 transition-colors text-sm font-medium cursor-pointer"
                        >
                            <History size={16} />
                            <span className="hidden sm:inline">Riwayat</span>
                        </button>
                        
                        <button 
                            onClick={handleSaveToHistory}
                            className={`flex items-center gap-2 px-3 py-2 rounded-lg transition-colors text-sm font-medium cursor-pointer border ${saveStatus === 'saved' ? 'bg-green-100 border-green-200 text-green-700' : 'bg-white border-[#D1D8C6] text-meramu-dark hover:bg-gray-50'}`}
                        >
                            {saveStatus === 'saved' ? <Check size={16} /> : <Save size={16} />}
                            <span className="hidden sm:inline">{saveStatus === 'saved' ? 'Tersimpan' : 'Simpan'}</span>
                        </button>

                        <button 
                            onClick={handleSaveJpeg}
                            className="flex items-center gap-2 bg-[#D1D8C6] text-meramu-dark px-3 py-2 rounded-lg hover:bg-[#C2CBB5] transition-colors text-sm font-medium cursor-pointer"
                        >
                            <ImageIcon size={16} />
                            <span className="hidden sm:inline">Simpan JPG</span>
                        </button>
                        <button 
                            onClick={handlePrint}
                            className="flex items-center gap-2 bg-meramu-green text-white px-4 py-2 rounded-lg hover:bg-[#407558] transition-colors text-sm font-medium shadow-sm cursor-pointer"
                        >
                            <Printer size={16} />
                            <span className="hidden sm:inline">Cetak</span>
                        </button>
                    </div>
                </div>

                {/* MODAL AI & TEMPLATE */}
                {showAI && (
                    <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 no-print">
                        <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg flex flex-col overflow-hidden h-[80vh] max-h-[600px]">
                            <div className="p-4 bg-meramu-green text-white flex justify-between items-center">
                                <h2 className="text-lg font-bold flex items-center gap-2">
                                    <Sparkles size={20} className="text-yellow-300" /> 
                                    Asisten & Template
                                </h2>
                                <button onClick={() => setShowAI(false)} className="text-white/80 hover:text-white">
                                    <X size={20} />
                                </button>
                            </div>
                            
                            <div className="flex border-b border-gray-100">
                                <button 
                                    onClick={() => { setAiTab('reply'); setAiResult(null); }}
                                    className={`flex-1 py-3 text-sm font-medium ${aiTab === 'reply' ? 'text-meramu-green border-b-2 border-meramu-green bg-green-50' : 'text-gray-500 hover:bg-gray-50'}`}
                                >
                                    üí¨ Template Balasan
                                </button>
                                <button 
                                    onClick={() => { setAiTab('consult'); }}
                                    className={`flex-1 py-3 text-sm font-medium ${aiTab === 'consult' ? 'text-meramu-green border-b-2 border-meramu-green bg-green-50' : 'text-gray-500 hover:bg-gray-50'}`}
                                >
                                    ü§ñ Konsultasi AI
                                </button>
                            </div>

                            <div className="p-6 bg-[#FEFCF8] flex-1 overflow-y-auto">
                                {/* TAB 1: TEMPLATE BALASAN */}
                                {aiTab === 'reply' && (
                                    <div className="space-y-4">
                                        <p className="text-sm text-gray-600">Pilih template pesan untuk klien:</p>
                                        <div className="grid grid-cols-1 gap-2">
                                            <button onClick={() => generateReplyTemplate('pricelist')} className="text-left p-3 border rounded-lg bg-green-50 border-meramu-green hover:bg-meramu-cream transition-colors text-sm text-meramu-dark font-medium">
                                                üìß Kirim Pricelist & Nego
                                            </button>
                                            <button onClick={() => generateReplyTemplate('nego')} className="text-left p-3 border rounded-lg hover:bg-meramu-cream hover:border-meramu-green transition-colors text-sm text-meramu-dark font-medium">
                                                üìâ Menanggapi Nego Harga
                                            </button>
                                            <button onClick={() => generateReplyTemplate('dp')} className="text-left p-3 border rounded-lg hover:bg-meramu-cream hover:border-meramu-green transition-colors text-sm text-meramu-dark font-medium">
                                                üí∏ Menagih DP (Awal Project)
                                            </button>
                                            <button onClick={() => generateReplyTemplate('invoice')} className="text-left p-3 border rounded-lg hover:bg-meramu-cream hover:border-meramu-green transition-colors text-sm text-meramu-dark font-medium">
                                                ‚úÖ Mengirim Invoice Pelunasan
                                            </button>
                                        </div>

                                        {aiResult && (
                                            <div className="mt-4 bg-white border border-dashed border-meramu-green rounded-lg p-4 relative animate-fade-in">
                                                <div className="absolute top-2 right-2">
                                                    <button onClick={() => handleCopyText(aiResult.content)} className="text-meramu-green hover:bg-green-50 p-1.5 rounded" title="Salin Teks">
                                                        <Copy size={16} />
                                                    </button>
                                                </div>
                                                <h4 className="text-xs font-bold text-meramu-green uppercase mb-2">Draft Pesan:</h4>
                                                <p className="text-sm text-gray-700 whitespace-pre-wrap leading-relaxed">
                                                    {aiResult.content}
                                                </p>
                                            </div>
                                        )}
                                    </div>
                                )}

                                {/* TAB 2: KONSULTASI AI (DIRECT CHAT) */}
                                {aiTab === 'consult' && (
                                    <div className="space-y-4 h-full flex flex-col">
                                        {!userApiKey && (
                                            <div className="bg-orange-50 border border-orange-200 text-orange-800 text-xs p-3 rounded-lg mb-2">
                                                <p className="font-bold mb-1">Butuh API Key Gemini</p>
                                                <p className="mb-2">Untuk konsultasi langsung, masukkan API Key Anda (gratis dari Google).</p>
                                                <input 
                                                    type="text" 
                                                    placeholder="Paste API Key disini..."
                                                    className="w-full p-2 border rounded text-xs bg-white"
                                                    onChange={handleSaveApiKey}
                                                />
                                                <p className="mt-1 text-[10px] text-gray-500">*Key disimpan di browser Anda saja.</p>
                                            </div>
                                        )}

                                        <div className="flex-1 overflow-y-auto bg-white border border-[#D1D8C6] rounded-lg p-3 min-h-[200px]">
                                            {!aiChatResponse ? (
                                                <div className="text-center text-gray-400 text-sm py-10">
                                                    <p>Tanyakan apa saja ke Gemini!</p>
                                                    <p className="text-xs">"Berapa harga pasaran desain logo?"</p>
                                                </div>
                                            ) : (
                                                <div className="text-sm text-gray-700 prose prose-sm max-w-none" dangerouslySetInnerHTML={{ __html: marked.parse(aiChatResponse) }}></div>
                                            )}
                                            {isAiLoading && (
                                                <div className="text-center py-2">
                                                    <span className="inline-block animate-bounce text-meramu-green">‚óè</span>
                                                    <span className="inline-block animate-bounce delay-100 text-meramu-green">‚óè</span>
                                                    <span className="inline-block animate-bounce delay-200 text-meramu-green">‚óè</span>
                                                </div>
                                            )}
                                        </div>

                                        <div className="flex gap-2 mt-2">
                                            <input 
                                                value={chatInput}
                                                onChange={(e) => setChatInput(e.target.value)}
                                                onKeyDown={(e) => e.key === 'Enter' && callGeminiChat()}
                                                placeholder="Ketik pertanyaanmu..."
                                                className="flex-1 p-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:border-meramu-green"
                                                disabled={isAiLoading}
                                            />
                                            <button 
                                                onClick={callGeminiChat}
                                                disabled={isAiLoading || !userApiKey}
                                                className={`p-2 rounded-lg text-white transition-colors ${isAiLoading || !userApiKey ? 'bg-gray-300 cursor-not-allowed' : 'bg-meramu-green hover:bg-[#407558]'}`}
                                            >
                                                <Send size={18} />
                                            </button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                )}

                {/* MODAL RIWAYAT */}
                {showHistory && (
                    <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 no-print">
                        <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[80vh] flex flex-col">
                            <div className="p-4 border-b border-gray-100 flex justify-between items-center bg-[#FAF9F6] rounded-t-xl">
                                <h2 className="text-lg font-bold text-meramu-dark flex items-center gap-2">
                                    <History size={20} /> Riwayat Dokumen
                                </h2>
                                <button onClick={() => setShowHistory(false)} className="text-gray-400 hover:text-gray-600">
                                    <X size={20} />
                                </button>
                            </div>
                            
                            <div className="overflow-y-auto p-4 custom-scrollbar flex-1 bg-[#FEFCF8]">
                                {savedHistory.length === 0 ? (
                                    <div className="text-center py-10 text-gray-400">
                                        <p>Belum ada riwayat tersimpan.</p>
                                        <p className="text-xs mt-1">Klik tombol "Simpan" untuk menyimpan dokumen.</p>
                                    </div>
                                ) : (
                                    <div className="space-y-3">
                                        {savedHistory.map((item) => (
                                            <div 
                                                key={item.id}
                                                onClick={() => handleLoadFromHistory(item)}
                                                className="group border border-[#E6E8E0] bg-white p-4 rounded-lg hover:border-meramu-green hover:shadow-sm cursor-pointer transition-all flex justify-between items-center"
                                            >
                                                <div>
                                                    <div className="flex items-center gap-2 mb-1">
                                                        <span className={`text-[10px] uppercase font-bold px-2 py-0.5 rounded ${
                                                            item.docType === 'quotation' ? 'bg-blue-100 text-blue-700' :
                                                            item.docType === 'invoice_dp' ? 'bg-orange-100 text-orange-700' :
                                                            'bg-green-100 text-green-700'
                                                        }`}>
                                                            {getDocTitle(item.docType).main}
                                                        </span>
                                                        <span className="text-xs text-gray-400">{item.saveDate}</span>
                                                    </div>
                                                    <h3 className="font-bold text-meramu-dark">{item.quotationData.clientName}</h3>
                                                    <p className="text-xs text-[#6B786D]">{item.quotationData.number} ‚Ä¢ {formatIDR(item.grandTotal)}</p>
                                                </div>
                                                <button 
                                                    onClick={(e) => handleDeleteHistory(item.id, e)}
                                                    className="p-2 text-gray-300 hover:text-red-500 hover:bg-red-50 rounded-full transition-colors"
                                                    title="Hapus dari riwayat"
                                                >
                                                    <Trash2 size={18} />
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                )}

                {/* Kertas Quotation */}
                <div id="quotation-paper" className="max-w-4xl mx-auto bg-white shadow-xl rounded-none md:rounded-lg overflow-hidden print:shadow-none print:w-full print:max-w-full print:bg-white">
                    
                    {/* Header Warna Sage Baru */}
                    <div className="bg-meramu-green text-white p-10 print:bg-meramu-green print:text-white print-color-adjust-exact">
                    <div className="flex justify-between items-start">
                        <div>
                        <h1 className="text-3xl font-bold tracking-wider uppercase mb-1 text-[#F2EFE5]">{getDocTitle(docType).main}</h1>
                        <p className="opacity-80 text-sm tracking-widest uppercase text-[#D8DCC8]">{getDocTitle(docType).sub}</p>
                        </div>
                        <div className="text-right w-1/2">
                        <div className="flex items-center justify-end gap-3 mb-2">
                             <input 
                                type="text" 
                                value={quotationData.senderName}
                                onChange={(e) => setQuotationData({...quotationData, senderName: e.target.value})}
                                className="bg-transparent text-right font-bold text-2xl w-full focus:outline-none placeholder-[#A9B388] text-[#F2EFE5]"
                                placeholder="Nama Perusahaan Anda"
                            />
                        </div>
                        <textarea 
                            value={quotationData.senderAddress}
                            onChange={(e) => setQuotationData({...quotationData, senderAddress: e.target.value})}
                            className="bg-transparent text-right w-full text-sm opacity-90 focus:outline-none resize-none h-16 text-[#E6E8D8] leading-relaxed"
                            placeholder="Alamat Lengkap"
                        />
                        </div>
                    </div>
                    </div>

                    {/* Info Detail */}
                    <div className="p-10">
                    <div className="flex flex-col md:flex-row justify-between gap-10 mb-12">
                        <div className="w-full md:w-1/2">
                        <h3 className="text-meramu-green text-xs font-bold uppercase tracking-widest mb-3">Ditujukan Kepada (Client)</h3>
                        <input 
                            type="text" 
                            value={quotationData.clientName}
                            onChange={(e) => setQuotationData({...quotationData, clientName: e.target.value})}
                            className="block w-full text-xl font-bold text-meramu-dark mb-2 border-b border-transparent hover:border-[#D1D8C6] focus:border-meramu-green focus:outline-none transition-colors"
                            placeholder="Nama Klien"
                        />
                        <textarea 
                            value={quotationData.clientAddress}
                            onChange={(e) => setQuotationData({...quotationData, clientAddress: e.target.value})}
                            className="block w-full text-[#6B786D] resize-none h-20 border-b border-transparent hover:border-[#D1D8C6] focus:border-meramu-green focus:outline-none transition-colors leading-relaxed"
                            placeholder="Alamat Klien"
                        />
                        </div>
                        <div className="w-full md:w-5/12 space-y-4">
                        <div className="flex justify-between items-center border-b border-[#EFECE5] pb-2">
                            <span className="text-[#6B786D] text-sm font-medium">No. Dokumen</span>
                            <input 
                            type="text" 
                            value={quotationData.number}
                            readOnly
                            className="text-right font-bold text-meramu-dark w-full bg-transparent focus:outline-none"
                            title="Nomor dokumen dibuat otomatis"
                            />
                        </div>
                        <div className="flex justify-between items-center border-b border-[#EFECE5] pb-2">
                            <span className="text-[#6B786D] text-sm font-medium">Tanggal</span>
                            <input 
                            type="date" 
                            value={quotationData.date}
                            onChange={(e) => setQuotationData({...quotationData, date: e.target.value})}
                            className="text-right font-medium text-meramu-dark focus:outline-none"
                            />
                        </div>
                        <div className="flex justify-between items-center border-b border-[#EFECE5] pb-2">
                            <span className="text-[#6B786D] text-sm font-medium">
                                {docType === 'quotation' ? 'Berlaku Sampai' : 'Jatuh Tempo'}
                            </span>
                            <input 
                            type="date" 
                            value={quotationData.dueDate}
                            onChange={(e) => setQuotationData({...quotationData, dueDate: e.target.value})}
                            className="text-right font-medium text-meramu-dark focus:outline-none"
                            />
                        </div>
                        </div>
                    </div>

                    {/* Tabel Item */}
                    <table className="w-full mb-8">
                        <thead>
                        <tr className="bg-[#F2F4ED] border-y border-[#E6E8E0]">
                            <th className="text-left py-4 px-3 text-xs font-bold text-meramu-green uppercase tracking-widest w-1/2">Lingkup Pekerjaan (Scope)</th>
                            <th className="text-center py-4 px-3 text-xs font-bold text-meramu-green uppercase tracking-widest w-20">Qty</th>
                            <th className="text-right py-4 px-3 text-xs font-bold text-meramu-green uppercase tracking-widest w-36">Harga</th>
                            <th className="text-right py-4 px-3 text-xs font-bold text-meramu-green uppercase tracking-widest w-40">Total</th>
                            <th className="w-10 no-print"></th>
                        </tr>
                        </thead>
                        <tbody className="divide-y divide-[#F2F4ED]">
                        {items.map((item) => (
                            <tr key={item.id} className="group hover:bg-[#F9FBF7] transition-colors">
                            <td className="py-4 px-3 align-top">
                                <textarea 
                                value={item.description}
                                onChange={(e) => handleItemChange(item.id, 'description', e.target.value)}
                                className="w-full bg-transparent focus:outline-none font-medium text-meramu-dark resize-none h-auto min-h-[1.5rem]"
                                rows={2}
                                placeholder="Deskripsi Item"
                                style={{ height: 'auto', minHeight: '40px' }}
                                />
                            </td>
                            <td className="py-4 px-3 align-top">
                                <input 
                                type="number" 
                                min="1"
                                value={item.qty}
                                onChange={(e) => handleItemChange(item.id, 'qty', parseInt(e.target.value) || 0)}
                                className="w-full text-center bg-transparent focus:outline-none text-[#6B786D] font-medium"
                                />
                            </td>
                            <td className="py-4 px-3 text-right align-top">
                                <div className="flex items-center justify-end">
                                    <span className="text-[#A9B388] text-xs mr-2">Rp</span>
                                    <input 
                                    type="number" 
                                    min="0"
                                    value={item.price}
                                    onChange={(e) => handleItemChange(item.id, 'price', parseInt(e.target.value) || 0)}
                                    className="w-28 text-right bg-transparent focus:outline-none text-[#6B786D] font-medium"
                                    />
                                </div>
                            </td>
                            <td className="py-4 px-3 text-right font-bold text-meramu-dark align-top">
                                {formatIDR(item.qty * item.price)}
                            </td>
                            <td className="py-4 px-3 text-center no-print align-top">
                                <button 
                                onClick={() => removeItem(item.id)}
                                className="text-[#D1D8C6] hover:text-[#B91C1C] transition-colors mt-1 cursor-pointer"
                                >
                                <Trash2 size={16} />
                                </button>
                            </td>
                            </tr>
                        ))}
                        </tbody>
                    </table>

                    <button 
                        onClick={addItem}
                        className="mb-10 flex items-center gap-2 text-meramu-green hover:text-meramu-dark text-sm font-semibold no-print transition-colors cursor-pointer"
                    >
                        <div className="bg-[#F2F4ED] p-1 rounded-full">
                        <Plus size={14} /> 
                        </div>
                        Tambah Item Baru
                    </button>

                    {/* Bagian Total */}
                    <div className="flex flex-col md:flex-row justify-end border-t-2 border-meramu-green pt-8">
                        <div className="w-full md:w-1/2 lg:w-5/12 space-y-4">
                        <div className="flex justify-between items-center text-[#6B786D]">
                            <span className="font-medium">Subtotal</span>
                            <span className="font-medium">{formatIDR(subtotal)}</span>
                        </div>
                        
                        <div className="flex justify-between items-center text-[#4A5D4F] bg-[#F2F4ED] p-2 rounded -mx-2">
                            <div className="flex items-center gap-2">
                            <span className="font-medium">Diskon</span>
                            <div className="flex items-center bg-white border border-[#D1D8C6] rounded px-2 py-0.5 no-print shadow-sm">
                                <input 
                                type="number" 
                                min="0" 
                                max="100"
                                value={discountPercent}
                                onChange={(e) => setDiscountPercent(parseInt(e.target.value) || 0)}
                                className="w-10 text-right focus:outline-none text-sm font-medium text-[#4A5D4F]"
                                />
                                <span className="text-xs ml-1">%</span>
                            </div>
                            <span className="hidden print:inline text-xs font-medium">({discountPercent}%)</span>
                            </div>
                            <span className="font-medium">- {formatIDR(discountAmount)}</span>
                        </div>

                        <div className="flex justify-between items-center text-[#6B786D]">
                            <div className="flex items-center gap-2">
                            <span className="font-medium">Pajak (PPN)</span>
                            <div className="flex items-center bg-[#F2F4ED] rounded px-2 py-0.5 no-print">
                                <input 
                                type="number" 
                                min="0" 
                                max="100"
                                value={taxPercent}
                                onChange={(e) => setTaxPercent(parseInt(e.target.value) || 0)}
                                className="w-8 text-right bg-transparent focus:outline-none text-xs"
                                />
                                <span className="text-xs ml-1">%</span>
                            </div>
                            <span className="hidden print:inline text-xs">({taxPercent}%)</span>
                            </div>
                            <span className="font-medium">{formatIDR(taxAmount)}</span>
                        </div>

                        {/* Grand Total */}
                        <div className={`flex justify-between items-center pt-4 ${docType === 'invoice_final' ? 'text-[#6B786D] pb-2' : 'border-t border-[#EFECE5] mt-2 text-2xl font-bold text-meramu-dark'}`}>
                            <span className={docType === 'invoice_final' ? "font-medium" : ""}>
                                {docType === 'invoice_final' ? 'Total Project' : 'Total'}
                            </span>
                            <span>{formatIDR(grandTotal)}</span>
                        </div>

                        {/* Pengurangan DP */}
                        {docType === 'invoice_final' && (
                            <div className="flex justify-between items-center text-[#B91C1C] bg-red-50 p-2 rounded -mx-2 border border-red-100">
                                <span className="font-medium">Dikurangi DP (Sudah Dibayar)</span>
                                <span className="font-bold">- {formatIDR(dpAmount)}</span>
                            </div>
                        )}

                        {/* Total Tagihan Akhir */}
                        {(docType === 'invoice_dp' || docType === 'invoice_final') && (
                            <div className="flex justify-between items-center pt-4 border-t-2 border-meramu-green mt-2">
                                <span className="text-xl md:text-2xl font-bold text-meramu-dark">
                                    {docType === 'invoice_dp' ? 'Total Tagihan DP' : 'Sisa Tagihan'}
                                </span>
                                <span className="text-xl md:text-2xl font-bold text-meramu-green">
                                    {formatIDR(docType === 'invoice_dp' ? dpAmount : remainingAmount)}
                                </span>
                            </div>
                        )}

                        {/* Info DP */}
                        {docType === 'quotation' && (
                            <div className="bg-[#F9FBF7] rounded-lg p-3 mt-4 border border-[#E6E8E0] print:border-none print:p-0 print:bg-transparent">
                                <div className="flex justify-between items-center mb-2 pb-2 border-b border-dashed border-[#A9B388]">
                                <span className="font-semibold text-[#4A5D4F]">Down Payment (50%)</span>
                                <span className="font-bold text-[#4A5D4F]">{formatIDR(dpAmount)}</span>
                                </div>
                                <div className="flex justify-between items-center pt-1">
                                <span className="text-sm font-medium text-[#6B786D]">Sisa Pelunasan</span>
                                <span className="text-sm font-medium text-[#6B786D]">{formatIDR(remainingAmount)}</span>
                                </div>
                            </div>
                        )}
                        
                        </div>
                    </div>

                    {/* Footer & Tanda Tangan */}
                    <div className="mt-20 grid grid-cols-1 md:grid-cols-2 gap-12">
                        <div>
                        <h4 className="font-bold text-meramu-green mb-3 text-sm uppercase tracking-wider">Catatan:</h4>
                        <textarea 
                            value={quotationData.notes}
                            onChange={(e) => setQuotationData({...quotationData, notes: e.target.value})}
                            className="w-full text-sm text-[#6B786D] h-32 bg-[#F9FBF7] p-4 rounded-lg border border-transparent hover:border-[#D1D8C6] focus:outline-none focus:border-[#A9B388] resize-none print:bg-transparent print:p-0 leading-relaxed"
                        />
                        
                        <div className="mt-6 text-xs text-[#8C9885]">
                            <p>Transfer Pembayaran ke:</p>
                            <p className="font-medium text-[#6B786D] text-sm mt-1">BCA 5271779586 a.n Andreana Dewi</p>
                        </div>
                        </div>
                        
                        <div className="text-center md:text-right flex flex-col items-center md:items-end justify-end">
                        <p className="text-sm text-[#6B786D] mb-20">Hormat Kami,</p>
                        <div className="border-t-2 border-meramu-green w-48"></div>
                        <input 
                            type="text"
                            value={quotationData.senderName}
                            onChange={(e) => setQuotationData({...quotationData, senderName: e.target.value})}
                            className="text-center md:text-right mt-3 font-bold text-lg text-meramu-dark focus:outline-none bg-transparent w-full"
                        />
                        <p className="text-xs text-[#8C9885] mt-1">Freelance Graphic Designer</p>
                        </div>
                    </div>
                    </div>
                    
                    {/* Footer Bar */}
                    <div className="bg-[#FAF9F6] p-4 text-center text-xs text-[#A9B388] no-print border-t border-[#EFECE5]">
                    Dokumen ini dibuat dengan Meramu Design Tools.
                    </div>
                </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<QuotationApp />);
    </script>
</body>
</html>